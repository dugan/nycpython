{% extends "topics/base.html" %}
{% load voting_tags %}
{% block body %}
<form method="POST" action="submit">
    <h3>Search For/Add a topic</h3>
    <p>
    <textarea id="title" cols="60" rows="3">{{search_term}}</textarea>
    </p>
    <div id="notopics">
	<b>Would you like to suggest this topic?</b>
	<p><input id="volunteer" name="volunteer" type="checkbox">Check here to volunteer to present on this topic (you can do this later)</input></p>
	<input id="create" type="button" value="Suggest">
	<h3>No topics found</h3>
	<p>No topics matched your search.</p>
	<p>
	</p>
    </div>
    <div id="search_results">
	<h3>Potential topics:</h3>
	<ol class="topics" id="topics">
	</ol>
    </div>
</form>
{% endblock %}
{% block sidebar %}
    {% if meeting %}
    <h3>Next Meeting: {{meeting.date|date:"l, F dS"}} at
	{{meeting.date|date:"P" }}</h3>
    <p>Determine what's going to happen at future {{site.name}} meetings!</p>
    <p>Vote on a topic, suggest a new topic, or offer to present on a topic that's already been suggested!</p>
    <p>See the <a href="{% url meeting_detail meeting.id %}">meeting details</a></p>
    {% else %}
    <h3>No meeting scheduled</h3>
    <p>No meetings are scheduled.  You can still create and vote on
    topics though to show your interest, or look through the list of <a
	href="{% url meeting_list %}">previous meetings</a></p>
    {% endif %}
{% endblock %}

{% block footer %}
{{block.super}}
<script type="text/javascript">

var create_topic_done = function(res, status) {
  if (status == "success") {
    var data = eval("(" + res.responseText + ")");
    update_search();
    display_success(data["msg"], $("#title"));
  }
  else {
    display_error(res.responseText, $("#title"));
  }
  return false;
}


var create_topic = function() {
  var title = $("#title").val()
  if (title != "" ) {
    var data = { title:title };
    if($('#volunteer').is(':checked')) {
        data['volunteer'] = 1;
    }
    var args = { type:"POST", url:"{% url create_topic %}", data:data, complete:create_topic_done };
    $.ajax(args);
  }
  else {
    display_error("Please enter a topic.", $("#title"));
  }
  return false;
};

var vote_done = function(res, status, topic_id) {
    if (status == "success") {
	var data = eval("(" + res.responseText + ")");
	votes = data['score']['score'];
	$("#vote_count_"+topic_id).html(votes);
	$("#vote_up_"+topic_id).html("Voted");
        return false;
    }
    else {
	display_error(res.responseText, $(".vote"));
    }
}

var add_vote = function() {
    topic_id = $(this).attr('id').substring(8);

    $.ajax({
	type: "POST",
	data: {HTTP_X_REQUESTED:'XMLHttpRequest'},
	url: "{{request.META.SCRIPT_NAME}}/topics/" + topic_id + "/vote",
	complete: function(res, status) {return vote_done(res, status, topic_id);}
    });
    return false;
};

var search_done = function(res, status) {
    if (status == "success") {
	var data = eval("(" + res.responseText + ")");
	set_topic_list(data["topics"], "#topics");
	$(".vote_up").click(add_vote);
    }
    else {
	display_error(res.responseText, $("#title"));
    }
}


var update_search = function() {
    $("#topic_list").html("Loading topics...");
    var q = $("#title").val();
    $.ajax({
	type: "GET",
	data: {"q" : q},
	url: "{% url topic_search %}",
	complete: search_done
    });
}


$(document).ready(function() {
{% if user.is_authenticated %}
$("#create").click(create_topic);
$(".vote_up").click(add_vote);
{% else %}
$("#create").colorbox({inline:true, href:"#reg_popup", transition: "fade"})
$(".vote_up").colorbox({inline:true, href:"#reg_popup", transition: "fade"})
{% endif %}
$("#title").keyup(update_search);
update_search();
})
</script>
{% endblock %}
